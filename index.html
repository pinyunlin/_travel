<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—…</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #0f1020;
    color: #f5f7ff;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",sans-serif;
  }
  #gameWrap {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #game {
    border: 1px solid rgba(255,255,255,0.15);
    background: radial-gradient(1200px 600px at 50% 100%, #1d1f44 0%, #101130 60%, #0f1020 100%);
    image-rendering: pixelated;
    width: 960px; height: 540px;
    max-width: 96vw; max-height: 54vw;
  }
  #hud {
    position: fixed; left: 0; right: 0; top: 10px;
    display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
    pointer-events: none;
  }
  .pill {
    pointer-events: auto;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    padding: 8px 12px; border-radius: 999px;
    font-size: 14px; display: inline-flex; align-items: center; gap: 6px;
  }

  /* å³ä¸Šè§’è¨­å®šæŒ‰éˆ• */
  #settingsBtn {
    position: fixed; right: 14px; top: 14px; z-index: 10;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff; padding: 8px 12px; border-radius: 12px;
    cursor: pointer; font-size: 14px;
  }
  #settingsBtn:hover { background: rgba(255,255,255,0.18); }

  .overlay {
    position: fixed; inset: 0; display: none; place-items: center;
    background: rgba(6,7,18,0.75); backdrop-filter: blur(3px);
  }
  .card {
    width: min(760px, 92vw);
    background: #181a3a;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    padding: 18px 18px 14px;
  }
  .card h2 { margin: 6px 0 8px; font-size: 22px; }
  .card p { line-height: 1.75; white-space: pre-wrap; }
  .btnRow { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  button { background: #ffffff10; color: #fff; border: 1px solid #ffffff30;
    padding: 10px 14px; border-radius: 12px; cursor: pointer; font-size: 14px; }
  button.primary { background: #7c8aff; border-color: #7c8aff; color: #0f1020; font-weight: 700; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  input[type="checkbox"].toggle {
    appearance: none; width: 36px; height: 22px; position: relative;
    background: #ffffff22; border: 1px solid #ffffff44; border-radius: 22px; outline: none;
  }
  input[type="checkbox"].toggle:checked { background: #7c8aff; border-color: #7c8aff; }
  input[type="checkbox"].toggle::after {
    content: ""; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
    border-radius: 50%; background: #fff; transition: transform .2s;
  }
  input[type="checkbox"].toggle:checked::after { transform: translateX(14px); }

  .grid {
    display: grid; gap: 10px;
  }
  .grid.cols2 { grid-template-columns: 1fr 1fr; }
  label { font-size: 13px; opacity: .9; }
  input[type="text"] { width: 100%; padding: 8px 10px; border-radius: 8px;
    border: 1px solid #ffffff22; background: #0f1028; color: #fff; }
  .row { display: flex; gap: 8px; align-items: center; }
  small.muted { opacity: .7; }
  footer { text-align: center; font-size: 12px; opacity: .6; padding: 8px 0 14px; }

  /* ä¿¡ä»¶æ¨£å¼ */
  #letterBody {
    font-size: 14px; /* ç¸®å°å­—é«” */
    max-height: 60vh; /* æœ€å¤§é«˜åº¦ï¼Œé¿å…è¶…å‡ºè¢å¹• */
    overflow-y: auto; /* è‹¥å…§å®¹å¤ªé•·ï¼Œå¯æ»¾å‹• */
    margin-bottom: 10px; /* å¢åŠ èˆ‡æŒ‰éˆ•çš„è·é›¢ */
  }
  
  /* å‚³é€é–€æ¨£å¼ */
  #quizTitle {
    margin-top: 0;
  }
</style>
</head>
<body>
  <!-- ä¿®æ”¹ HUD é¡¯ç¤ºéƒ¨åˆ† -->
  <div id="hud">
    <div class="pill">â¤ ç”Ÿå‘½ï¼š<span id="lives">3</span></div>
    <div class="pill">â˜… æ”¶é›†ï¼š<span id="gems">0</span></div>
    <div class="pill">ç¬¬ <span id="levelNo">1</span> é—œï¼š<span id="levelName">ä¸ä¿¡ä»»</span></div>
  </div>

  <button id="settingsBtn">âš™ï¸ è¨­å®š</button>

  <div id="gameWrap">
    <canvas id="game" width="960" height="540"></canvas>
  </div>

  <!-- é–‹é ­æ•…äº‹ -->
  <div class="overlay" id="introOverlay" aria-modal="true" role="dialog">
    <div class="card">
     
      <p>
ğŸª¶åœ¨é™é çš„åœ‹åº¦ä¸­ï¼Œæœ‰ä¸€ä½æ“æœ‰æ„›èˆ‡å‹‡æ°£çš„jp
ç¾åœ¨ä»–è¦ç©¿è¶Šé‡é‡é›£é—œ
å»è¦‹åˆ°å®ƒåœ¨å¿ƒè£¡æƒ³äº†å¾ˆä¹…çš„pj

æ”¶é›†æ˜Ÿæ˜Ÿä¸¦é€éæ„›å¿ƒå‚³é€é–€å»æ‰¾åˆ°pjå§!

âœ‹æ“ä½œæ–¹å¼ï¼š
â† â†’ ç§»å‹•ã€€
ç©ºç™½éµ è·³èºï¼ˆæ”¯æ´é€£è·³ï¼å¯ä»¥åœ¨ç©ºä¸­å†æŒ‰ä¸€æ¬¡ï¼‰

      </p>
      <div class="btnRow">
        <button id="startBtn" class="primary">é–‹å§‹å†’éšª</button>
        <button id="openSettingsFromIntro">é–‹å•Ÿè¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šé¢æ¿ -->
  <div class="overlay" id="settingsOverlay" aria-modal="true" role="dialog">
    <div class="card">
      <h2>è¨­å®š</h2>
      <div class="grid cols2">
        <div>
          <h3>å¦‚ä½•æ“ä½œ</h3>
          <p>â† â†’ ç§»å‹•ã€ç©ºç™½éµè·³èºï¼ˆæ”¯æ´é€£è·³ï¼‰ã€‚ç¢°åˆ°å¿ƒå½¢å‚³é€é–€æœƒå‡ºç¾å•ç­”ï¼Œç­”å°æ‰æœƒé–‹å•Ÿä¸‹ä¸€æ®µæ—…ç¨‹ã€‚</p>
          <div class="row"><span>â™ª èƒŒæ™¯éŸ³æ¨‚</span><input id="bgmToggle" type="checkbox" class="toggle" checked /></div>
          <div class="row"><span>ğŸ”Š éŸ³æ•ˆ</span><input id="sfxToggle" type="checkbox" class="toggle" checked /></div>
        </div>
        <div>
          <h3>æ–°å¢æœ‰è¶£é¡Œç›®</h3>
          <label>å•é¡Œï¼š</label>
          <input id="qText" type="text" placeholder="ä¾‹å¦‚ï¼šæˆ‘å€‘ç¬¬ä¸€æ¬¡ç´„æœƒå»å“ªï¼Ÿ" />
          <div class="row">
            <label>é¸é … Aï¼š</label><input id="c1" type="text" placeholder="ä¾‹å¦‚ï¼šé›»å½±é™¢" style="flex:1" />
            <label class="row"><input id="c1ok" type="checkbox" /> æ­£ç¢º</label>
          </div>
          <div class="row">
            <label>é¸é … Bï¼š</label><input id="c2" type="text" placeholder="ä¾‹å¦‚ï¼šå…¬åœ’" style="flex:1" />
            <label class="row"><input id="c2ok" type="checkbox" /> æ­£ç¢º</label>
          </div>
          <div class="row">
            <label>é¸é … Cï¼š</label><input id="c3" type="text" placeholder="ä¾‹å¦‚ï¼šå’–å•¡å»³" style="flex:1" />
            <label class="row"><input id="c3ok" type="checkbox" /> æ­£ç¢º</label>
          </div>
          <div class="btnRow">
            <button id="addQ">æ–°å¢é¡Œç›®</button>
            <button id="resetQs">é‚„åŸé è¨­é¡Œç›®</button>
          </div>
          <small class="muted">ç›®å‰é¡Œæ•¸ï¼š<span id="qCount">0</span></small>
        </div>
      </div>
      <div class="btnRow" style="justify-content:flex-end">
        <button id="closeSettings" class="primary">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <!-- å•ç­”ã€ä¿¡ä»¶ã€çµå°¾ -->
  <div class="overlay" id="quizOverlay" aria-modal="true" role="dialog">
    <div class="card">
      <h3 id="quizTitle">å‚³é€é–€</h3>
      <p id="gateMsg" class="muted" style="margin-top:-6px;"></p>
      <p id="quizQ">è¨Šæ¯æ–‡å­—</p>
      <div id="quizChoices" class="btnRow"></div>
    </div>
  </div>

  <div class="overlay" id="letterOverlay" aria-modal="true" role="dialog">
    <div class="card">
      <h2>é æ–¹å¯„ä¾†çš„ä¿¡</h2>
      <p id="letterBody"></p>
      <div class="btnRow">
        <button id="acceptLetter" class="primary">æ”¶å…¥è¡Œå›Š</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="finalOverlay" aria-modal="true" role="dialog">
    <div class="card">
      <h2>ä¸€èµ·èµ°å§</h2>
      <p>
ç¶“éäº†é‡é‡å›°é›£ï¼Œçµ‚æ–¼èµ°åˆ°é€™è£¡äº†ã€‚<br/>
æ¥ä¸‹ä¾†çš„è·¯ä¹Ÿæ˜¯å¾ˆå¤šå›°é›£æ‹‰å“ˆå“ˆ 
å±±è·¯é¡›ç°¸ æœªä¾†å¯æœŸã€‚<br/>
      </p>
      <div class="btnRow"><button class="primary" id="restart">å†ç©ä¸€æ¬¡</button></div>
    </div>
  </div>

  <footer>Â© çµ¦æœ€æ„›çš„äººçš„å°å°å†’éšª</footer>

<script>
/* ===== éŸ³æ¨‚èˆ‡éŸ³æ•ˆï¼ˆWebAudioï¼‰ ===== */
let audioCtx = null;
let masterGain, sfxGain, bgmGain;
let sfxEnabled = true;
let bgmEnabled = true; // é è¨­é–‹å•Ÿ
const bgmNotes = [
  [261.63, .35, .05], [329.63, .35, .05], [392.00, .35, .05], [523.25, .55, .15],
  [392.00, .35, .05], [329.63, .35, .05], [293.66, .35, .05], [349.23, .55, .25],
];
let bgmTimer = null;
function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 0.8;
    sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.9;
    bgmGain = audioCtx.createGain(); bgmGain.gain.value = 0.25;
    sfxGain.connect(masterGain); bgmGain.connect(masterGain); masterGain.connect(audioCtx.destination);
  }
}
function playTone({freq=440, type='sine', dur=0.2, attack=0.01, release=0.08, gain=0.6, out=sfxGain, pitchSlide=0}) {
  if (!sfxEnabled && out===sfxGain) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, t0);
  if (pitchSlide) osc.frequency.exponentialRampToValueAtTime(Math.max(40, freq + pitchSlide), t0 + Math.max(0.05, dur-0.02));
  g.gain.setValueAtTime(0, t0);
  g.gain.linearRampToValueAtTime(gain, t0 + attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + attack + Math.max(0.01, dur - release));
  osc.connect(g).connect(out);
  osc.start(t0); osc.stop(t0 + dur + 0.02);
}
function playNoise({dur=0.15, attack=0.005, release=0.1, gain=0.4}) {
  if (!sfxEnabled) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const bufferSize = Math.floor(audioCtx.sampleRate * dur);
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
  const src = audioCtx.createBufferSource(); src.buffer = buffer;
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0, t0);
  g.gain.linearRampToValueAtTime(gain, t0 + attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + attack + release);
  src.connect(g).connect(sfxGain); src.start(t0);
}
function startBgm() {
  if (bgmEnabled && !bgmTimer) {
    ensureAudio();
    const schedule = () => {
      let t = audioCtx.currentTime;
      for (const [f, d, r] of bgmNotes) {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(f, t);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.22, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + d);
        osc.connect(g).connect(bgmGain);
        osc.start(t); osc.stop(t + d + 0.02);
        t += d + r;
      }
    };
    schedule();
    bgmTimer = setInterval(schedule, 4000);
  }
}
function stopBgm(){ if (bgmTimer) { clearInterval(bgmTimer); bgmTimer = null; } }
function setBgm(on){ bgmEnabled = on; if (!audioCtx) ensureAudio(); if (bgmEnabled){ audioCtx.resume(); startBgm(); } else { stopBgm(); } }
function setSfx(on){ sfxEnabled = on; if (audioCtx) audioCtx.resume(); }

/* ===== éŠæˆ²ç‹€æ…‹ ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const hudLives = document.getElementById('lives');
const hudGems = document.getElementById('gems');
const hudLevelNo = document.getElementById('levelNo');
const hudLevelName = document.getElementById('levelName'); // æ–°å¢é—œå¡åç¨±å…ƒç´ 
const quizOverlay = document.getElementById('quizOverlay');
const quizTitle = document.getElementById('quizTitle');
const gateMsg = document.getElementById('gateMsg');
const quizQ = document.getElementById('quizQ');
const quizChoices = document.getElementById('quizChoices');
const letterOverlay = document.getElementById('letterOverlay');
const finalOverlay = document.getElementById('finalOverlay');
const letterBody = document.getElementById('letterBody');
const acceptLetterBtn = document.getElementById('acceptLetter');
const restartBtn = document.getElementById('restart');
const settingsBtn = document.getElementById('settingsBtn');
const introOverlay = document.getElementById('introOverlay');
const settingsOverlay = document.getElementById('settingsOverlay');
const openSettingsFromIntro = document.getElementById('openSettingsFromIntro');
const closeSettings = document.getElementById('closeSettings');
const startBtn = document.getElementById('startBtn');
const bgmToggle = document.getElementById('bgmToggle');
const sfxToggle = document.getElementById('sfxToggle');
const qCount = document.getElementById('qCount');

// æ–°å¢ï¼šè¨˜éŒ„å·²å‡ºç¾çš„å•é¡Œç´¢å¼•
let usedQuestionIndices = [];

// æ–°å¢é¡Œç›®ç›¸é—œå…ƒç´ 
const qText = document.getElementById('qText');
const c1 = document.getElementById('c1'), c2 = document.getElementById('c2'), c3 = document.getElementById('c3');
const c1ok = document.getElementById('c1ok'), c2ok = document.getElementById('c2ok'), c3ok = document.getElementById('c3ok');
const addQ = document.getElementById('addQ'), resetQs = document.getElementById('resetQs');

// é¡Œåº«ï¼ˆå¯è¢«é‡è¨­ï¼‰
const DEFAULT_QUESTIONS = [
  {
    q: "ç« é­šæœ‰å¹¾é¡†å¿ƒè‡Ÿï¼Ÿ",
    choices: [
      {t:"1", correct:false},
      {t:"3", correct:true},
      {t:"5", correct:false},
    ]
  },
  {
    q: "ç•ªèŒ„æœ€æ—©åœ¨æ­æ´²è¢«ç•¶æˆä»€éº¼ï¼Ÿï¼Ÿ",
    choices: [
      {t:"è”¬èœ", correct:false},
      {t:"æ°´æœ", correct:false},
      {t:"æœ‰æ¯’æ¤ç‰©", correct:true},
    ]
  },
  {
    q: "éŸ“åœ‹çš„ã€Œæ¼¢æ±Ÿã€ä½æ–¼å“ªåº§åŸå¸‚ï¼Ÿ",
    choices: [
      {t:"å¤§é‚±", correct:false},
      {t:"å…‰å·", correct:false},
      {t:"é¦–çˆ¾", correct:true},
    ]
    
  },

  {
    q: "ä¸–ç•Œä¸Šæœ€æ—©è¢«äººé¡å–çš„èŒ¶ä¾†è‡ªå“ªå€‹åœ‹å®¶ï¼Ÿ",
    choices: [
      {t:"å°åº¦", correct:false},
      {t:"æ—¥æœ¬", correct:false},
      {t:"ä¸­åœ‹", correct:true},


    ]
    
  },

  {
    q: "ä¸–ç•Œä¸Šç¬¬ä¸€å€‹ã€Œç¶²è·¯è¡¨æƒ…ç¬¦è™Ÿ :) ã€å‡ºç¾åœ¨å“ªä¸€å¹´ï¼Ÿ",
    choices: [
      {t:"2002", correct:false},
      {t:"1992", correct:false},
      {t:"1982", correct:true},
      
    ]
    
  },
  {
    q: "éŸ“åœ‹äººæœ€å¸¸åƒçš„è¡—é ­å°åƒã€Œè¾£ç‚’å¹´ç³•ã€çš„éŸ“æ–‡æ˜¯ï¼Ÿ",
    choices: [
      {t:"ë–¡ë³¶ì´", correct:true},
      {t:"ê¹€ë°¥", correct:false},
      {t:"ìˆœëŒ€", correct:false},

    ]
    
  },
  {
    q: "éŸ“åœ‹æ¿Ÿå·å³¶æœ€æœ‰åçš„æ°´æœæ˜¯ï¼Ÿ",
    choices: [
      {t:"æ©˜å­", correct:true},
      {t:"è˜‹æœ", correct:false},
      {t:"é¦™è•‰", correct:false},

    ]
    
  },

  {
    q: "éŸ“åœ‹çš„åœ‹èŠ±æ˜¯ï¼Ÿ",
    choices: [
      {t:"æœ¨æ§¿èŠ±", correct:true},
      {t:"æ¢…èŠ±", correct:false},
      {t:"ç«ç‘°", correct:false},

    ]
    
  },

  {
    q: "æ—¥æœ¬çš„åœ‹èŠ±æ˜¯ä»€éº¼ï¼Ÿ",
    choices: [
      {t:"æ«»èŠ±", correct:true},
      {t:"èŠèŠ±", correct:false},
      {t:"æ¢…èŠ±", correct:false},

    ]
    
  },
   {
    q: "æ—¥æœ¬æ–°å¹´çš„æ™‚å€™ï¼Œå‚³çµ±ä¸Šæœƒåƒä»€éº¼å¹´èœï¼Ÿ",
    choices: [
      {t:"å£½å¸", correct:false},
      {t:"å¹´ç³•æ¹¯", correct:true},
      {t:"æµ·é®®ç…é¤…", correct:false},

    ]
    
  },
   {
    q: "æ—¥æœ¬çš„éµè·¯ä»¥ä»€éº¼èåä¸–ç•Œï¼Ÿ",
    choices: [
      {t:"æ–°å¹¹ç·š", correct:true},
      {t:"åœ°éµ", correct:false},
      {t:"æ™®é€šåˆ—è»Š", correct:false},

    ]
    
  },


  {
    q: "ä»€éº¼æ±è¥¿æ¯”æ˜Ÿæ˜Ÿæ›´äº®å—ï¼Ÿï¼Ÿ",
    choices: [
      {t:"æ‰“ç«æ©Ÿ", correct:false},
      {t:"LED", correct:false},
      {t:"ä½ çš„ç¬‘å®¹", correct:true},
      
    ]
    
  }
];
let QUESTIONS = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS)); // æ‹·è²
function refreshQCount(){ qCount.textContent = QUESTIONS.length; }
refreshQCount();

// ä¿¡ä»¶å…¨æ–‡
const LETTER_TEXT = `ä¸ƒå¤•å¿«æ¨‚
æƒ³æƒ³ä¸Šå€‹ä¸ƒå¤•æˆ‘é‚„ä¸æ•¢èººåœ¨ä½ çš„æ‰‹ä¸Šå‘¢å“ˆå“ˆ

å…ˆé“æ­‰ä¸€ä¸‹
å› ç‚ºè‡ªå·±ä¾†æ²’èª¿æ•´å¥½ï¼Œæœ‰æ™‚å€™å°äº‹æƒ…éå¤šçš„æƒ…ç·’ã€åæ¿€å‹•çš„è¨Šæ¯ã€‚
ä»¥åŠè†½æ€¯æƒ³åƒä¸­ä»–äººç›®å…‰çš„æŠ•å°„ï¼Œé€²è¡Œçš„æ‰¹åˆ¤å’Œå¥‡æ€ªçš„è¦æ±‚ã€‚

æ¥ä¸‹ä¾†
æƒ³èªªçš„è®šç¾çš„å¹³å¸¸éƒ½è¬›äº†æ‹‰
è¬è¬ä½ ç¸½æ˜¯å¾ˆæœ‰èƒ½é‡çš„å°æˆ‘å¥½
é›–ç„¶æˆ‘æ¯›å¾ˆå¤š é‚„æ˜¯æœ‰æ±è¥¿èƒ½ç™¼é›£
ç„¶å¾Œæˆ‘å°æˆ‘è‡ªå·±ä¹Ÿè¦ºå¾—æœ‰å¾ˆå¤šå•é¡Œ
ä½†ä½ éƒ½åŒ…å®¹ä¸‹ä¾†äº†
åœ¨æˆ‘å•æœ‰æ²’æœ‰å•é¡Œçš„æ™‚å€™éƒ½èªªæ²’é—œä¿‚
æœ¬ä¾†éƒ½æƒ³å¥½è¢«ç½µå’Œè½åˆ°æœ‰è¶£æ±è¥¿çš„å¿ƒéƒ½è½ç©ºäº†å‘¢
åæ­£ä½ éƒ½ä¸çŸ¥é“ç‚ºä»€éº¼å¸æ”¶äº†æ‹‰
å²å®³

æœ€å¾Œ
ç¥æˆ‘å€‘èƒ½å„è‡ªè¶Šä¾†è¶Šå¥½
åŠ å†ä¸€èµ·æ›´å¥½!

ã‚ãªãŸã®ã‚ˆã†ãª
Je t'aime
ì‚¬ë‘í•´
`;

// é—œå¡è³‡æ–™
const LEVELS = [
  {
    platforms: [
      {x:0,y:500,w:960,h:40},
      {x:180,y:440,w:120,h:16},
      {x:360,y:390,w:140,h:16},
      {x:560,y:350,w:120,h:16},
      {x:760,y:310,w:140,h:16},
    ],
    spikes: [
      {x:80,y:484,w:60,h:16},
      {x:300,y:374,w:40,h:16}
    ],
    gems: [
      {x:200,y:410,got:false},
      {x:580,y:320,got:false}
    ],
    gate: {x:900,y:470,w:40,h:30, quizIndex:0}
  },
  {
    platforms: [
      {x:0,y:500,w:960,h:40},
      {x:120,y:460,w:120,h:16},
      {x:300,y:420,w:120,h:16},
      {x:480,y:380,w:120,h:16},
      {x:660,y:340,w:120,h:16},
      {x:820,y:300,w:100,h:16}
    ],
    spikes: [
      {x:230,y:444,w:50,h:16},
      {x:410,y:404,w:50,h:16},
      {x:590,y:364,w:50,h:16},
    ],
    gems: [
      {x:140,y:430,got:false},
      {x:500,y:350,got:false},
      {x:840,y:270,got:false}
    ],
    gate: {x:900,y:270,w:40,h:30, quizIndex:1}
  },
  {
    platforms: [
      {x:0,y:500,w:960,h:40},
      {x:180,y:460,w:160,h:16},
      {x:420,y:420,w:160,h:16},
      {x:660,y:380,w:160,h:16},
      {x:820,y:340,w:120,h:16}
    ],
    spikes: [
      {x:320,y:404,w:60,h:16},
      {x:560,y:364,w:60,h:16}
    ],
    gems: [
      {x:200,y:430,got:false},
      {x:440,y:390,got:false},
      {x:680,y:350,got:false}
    ],
    goal: {x:900,y:300,w:40,h:70}
  }
];

// å¹¾ä½•å°ç”Ÿç‰©ï¼ˆæ”¹ç‚ºå°è²“ï¼šåœ“èº« + è²“è€³ + é¬é¬š + çœ¼ç›é¼»å­ + æ‰‹è…³ï¼‰
const player = {
  x: 40, y: 460, vx: 0, vy: 0,
  w: 30, h: 30,
  onGround: false,
  lives: 2,  // å¾3æ”¹ç‚º2
  gems: 0,
  facing: 1,
  hasBackpack: false,
  jumpsLeft: 2
};
const MAX_JUMPS = 2;

// å…¶ä»–ç‹€æ…‹
let levelIndex = 0;
let playing = false; // é–‹å ´å…ˆæš«åœï¼Œç­‰æŒ‰ã€Œé–‹å§‹å†’éšªã€
let keys = new Set();
let gateLocked = false;
let letterShown = false;
let metPartner = false;

// å•ç­”æ¨¡å¼ï¼ˆå‚³é€é–€ or å¾©æ´»ï¼‰
let quizMode = "gate"; // "gate" | "revive"
let reviveCursor = 0;
const REVIVE_HP = 1;

// å‚³é€é–€æç¤ºè¨Šæ¯
const GATE_MESSAGES = {
  0: "æ­éº¥å°¬ï¼Œä½ æˆåŠŸäº†ï¼ä½ ç”¨é‹ç”¨äº†ä½ çš„çœŸèª å’Œç†±æƒ… æŒºéäº†åç‚º{ä¸ä¿¡ä»»}çš„é—œå¡ã€‚",
  1: "æ­éº¥å°¬ï¼Œä½ æ˜¯å¤©æ‰å§ï¼ä½ é‹ç”¨äº†ç¥å¥‡åŠ›é‡ï¼ŒæŒºéäº†åç‚º{æƒ…ç·’åŒ–åæ‡‰}çš„é—œå¡ã€‚",
};

// ä¿®æ”¹é—œå¡é¡¯ç¤ºåç¨±ï¼Œç‚ºæ¯ä¸€é—œæ·»åŠ ä¸»é¡Œåç¨±
const LEVEL_NAMES = ["ä¸ä¿¡ä»»", "æƒ…ç·’åŒ–åæ‡‰", "ç£¨åˆ"];

/* ===== å¹¾ä½•é‹ç®— ===== */
function rectsIntersect(a,b) {
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

/* ===== ç¹ªè£½ ===== */
function drawLevel(level) {
  ctx.fillStyle = '#39408d';
  level.platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
  level.spikes.forEach(s => drawSpike(s));
  level.gems.forEach(g => { if (!g.got) drawGem(g.x,g.y); });
  if (level.gate) drawGate(level.gate);
  if (level.goal) drawGoal(level.goal);
}
function drawSpike(s) {
  ctx.fillStyle = '#ef476f';
  ctx.beginPath();
  ctx.moveTo(s.x, s.y + s.h);
  ctx.lineTo(s.x + s.w/2, s.y);
  ctx.lineTo(s.x + s.w, s.y + s.h);
  ctx.closePath();
  ctx.fill();
}
// å®Œæ•´äº”è§’æ˜Ÿï¼ˆç”¨æ–¼æ”¶é›†ç‰©èˆ‡èƒŒæ™¯ï¼‰
function pathStar(cx, cy, outerR = 12, innerR = 5, points = 5) {
  const step = Math.PI / points;
  ctx.beginPath();
  for (let i = 0; i < points * 2; i++) {
    const r = (i % 2 === 0) ? outerR : innerR;
    const a = -Math.PI / 2 + i * step;
    const x = cx + Math.cos(a) * r;
    const y = cy + Math.sin(a) * r;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.closePath();
}
function drawGem(x,y) {
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(Math.sin(Date.now()/300)*0.15);
  ctx.fillStyle = '#ffd166';
  pathStar(0,0,10,4.5,5);
  ctx.fill();
  ctx.restore();
}
function drawGate(g) {
  const cx = g.x + g.w/2, cy = g.y + g.h/2;
  ctx.save(); ctx.translate(cx, cy); ctx.scale(1.1,1.1);
  ctx.fillStyle = '#e46dbc'; heartPath(0,0,18); ctx.fill();
  ctx.restore();
}
// ç›®æ¨™ï¼ˆæŠŠæ–¹å½¢å°ç”Ÿç‰©æ”¹ç‚ºç‹—ç‹—ï¼‰
function drawGoal(goal) {
  ctx.fillStyle = 'rgba(255,255,255,0.08)';
  ctx.fillRect(goal.x-20, goal.y-20, goal.w+40, goal.h+40);

  const x = goal.x, y = goal.y, w = goal.w;
  ctx.save();
  ctx.translate(x + w/2, y + w/2);

  // èº«é«”ï¼ˆåœ“è§’æ–¹å¡Šï¼‰
  const bodyW = w, bodyH = w*0.9, r = 8;
  ctx.fillStyle = '#7bdff2';
  roundedRect(-bodyW/2, -bodyH/2, bodyW, bodyH, r);
  ctx.fill();

  // è€³æœµï¼ˆç‹—ç‹—è€³ï¼šå·¦å³å°ä¸‹å‚ï¼‰
  ctx.fillStyle = '#59cbe8';
  ctx.beginPath();
  ctx.ellipse(-bodyW*0.35, -bodyH*0.55, 8, 12, 0, 0, Math.PI*2);
  ctx.ellipse(bodyW*0.35, -bodyH*0.55, 8, 12, 0, 0, Math.PI*2);
  ctx.fill();

  // çœ¼ç›
  ctx.fillStyle = '#0b0e2a';
  ctx.fillRect(-10, -2, 6, 6);
  ctx.fillRect(4, -2, 6, 6);

  // é¼»å£ï¼ˆå°åœ“é¼» + å˜´ï¼‰
  ctx.fillStyle = '#0b0e2a';
  ctx.beginPath(); ctx.arc(0, 6, 3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.moveTo(0, 9); ctx.lineTo(-3, 12); ctx.lineTo(3, 12); ctx.closePath(); ctx.fill();

  // æ„›å¿ƒæ•ˆæœ
  ctx.globalAlpha = 0.5;
  ctx.translate(0, -bodyH/2 - 14);
  ctx.fillStyle = '#f15bb5'; heartPath(0,0,26); ctx.fill();
  ctx.restore();
}
function roundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}
function heartPath(x,y,r) {
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.bezierCurveTo(x - r, y - r, x - r*1.6, y + r*0.6, x, y + r*1.6);
  ctx.bezierCurveTo(x + r*1.6, y + r*0.6, x + r, y - r, x, y);
}
// ç©å®¶ï¼ˆå°è²“ï¼‰
function drawPlayer() {
  const p = player;
  const t = Date.now()*0.006 + Math.abs(p.vx)*2;
  ctx.save();
  ctx.translate(p.x + p.w/2, p.y + p.h/2);

  // èº«é«”ï¼ˆåœ“ï¼‰
  ctx.fillStyle = '#80ffdb';
  ctx.beginPath(); ctx.arc(0,0,p.w/2,0,Math.PI*2); ctx.fill();

  // è²“è€³
  ctx.fillStyle = '#59f1dd';
  ctx.beginPath();
  ctx.moveTo(-8, -10); ctx.lineTo(-2, -18); ctx.lineTo(4, -10); ctx.closePath(); // å·¦è€³
  ctx.moveTo(8, -10); ctx.lineTo(2, -18); ctx.lineTo(-4, -10); ctx.closePath();  // å³è€³
  ctx.fill();

  // æ·»åŠ è…³çš„æ“ºå‹•
  const swing = Math.sin(t) * 4;
  ctx.strokeStyle = '#0b0e2a'; ctx.lineWidth = 3; ctx.lineCap = 'round';
  ctx.beginPath();
  // åªç•«è…³
  ctx.moveTo(-6, 12); ctx.lineTo(-6 + swing*0.2, 16);
  ctx.moveTo(6, 12); ctx.lineTo(6 - swing*0.2, 16);
  ctx.stroke();

  // çœ¼ç›
  ctx.fillStyle = '#0b0e2a';
  const eyeX = p.facing >= 0 ? 5 : -5;
  ctx.beginPath(); ctx.arc(eyeX-3, -2, 2.6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(eyeX+3, -2, 2.6, 0, Math.PI*2); ctx.fill();

  // é¼»å­ï¼ˆä¸‰è§’ï¼‰- ç§»é™¤äº†é¬é¬š
  ctx.fillStyle = '#0b0e2a';
  ctx.beginPath();
  ctx.moveTo(0, 1);
  ctx.lineTo(-2, 4);
  ctx.lineTo(2, 4);
  ctx.closePath();
  ctx.fill();

  // èƒŒåŒ…ï¼ˆçœ‹ä¿¡å¾Œï¼‰
  if (p.hasBackpack) { ctx.fillStyle = '#9bf6ff'; ctx.fillRect(-p.w/2 - 6, -8, 8, 16); }

  ctx.restore();
}

/* ===== ç‰©ç†èˆ‡æ›´æ–° ===== */
const GRAVITY = 0.6;
const JUMP_V = -10.5;
const MOVE_A = 0.8;
const FRICTION = 0.75;
const MAX_VX = 5.0;
const MAX_VY = 14;

function resetPlayer(spawnX=40, spawnY=460) {
  player.x = spawnX; player.y = spawnY;
  player.vx = 0; player.vy = 0; player.onGround = false;
  player.jumpsLeft = MAX_JUMPS;
}
function collidePlatformsHoriz(p, plats) {
  for (const pl of plats) {
    const a = {x:p.x, y:p.y, w:p.w, h:p.h};
    if (rectsIntersect(a, pl)) {
      if (p.vx > 0) p.x = pl.x - p.w;
      if (p.vx < 0) p.x = pl.x + pl.w;
      p.vx = 0;
    }
  }
}
function collidePlatformsVert(p, plats) {
  for (const pl of plats) {
    const a = {x:p.x, y:p.y, w:p.w, h:p.h};
    if (rectsIntersect(a, pl)) {
      if (p.vy > 0) { // å¾€ä¸‹è½åˆ°å¹³å°
        p.y = pl.y - p.h; p.vy = 0; p.onGround = true; p.jumpsLeft = MAX_JUMPS;
      } else if (p.vy < 0) { // å¾€ä¸Šæ’åˆ°å¹³å°
        p.y = pl.y + pl.h; p.vy = 0;
      }
    }
  }
}
function update() {
  if (!playing) return;
  const lvl = LEVELS[levelIndex];

  if (keys.has('ArrowLeft')) { player.vx -= MOVE_A; player.facing = -1; }
  if (keys.has('ArrowRight')) { player.vx += MOVE_A; player.facing = 1; }
  player.vx *= FRICTION; player.vx = Math.max(-MAX_VX, Math.min(MAX_VX, player.vx));

  player.vy += GRAVITY; player.vy = Math.min(player.vy, MAX_VY);

  player.x += player.vx; collidePlatformsHoriz(player, lvl.platforms);
  player.y += player.vy; player.onGround = false; collidePlatformsVert(player, lvl.platforms);

  // æ’¿æ˜Ÿæ˜Ÿ
  lvl.gems.forEach(g => {
    const box = {x:g.x-6,y:g.y-10,w:24,h:24};
    if (!g.got && rectsIntersect(player, box)) {
      g.got = true; player.gems++; hudGems.textContent = player.gems; playGem();
    }
  });

  // å°–åˆº
  lvl.spikes.forEach(s => {
    const box = {x:s.x, y:s.y, w:s.w, h:s.h};
    if (rectsIntersect(player, box)) { playHurt(); dieAndMaybeRevive(); }
  });

  // å‚³é€é–€
  if (lvl.gate && !gateLocked) {
    const box = {x:lvl.gate.x-8,y:lvl.gate.y-8,w:lvl.gate.w+16,h:lvl.gate.h+16};
    if (rectsIntersect(player, box)) {
      // æª¢æŸ¥ç©å®¶æ˜¯å¦æ”¶é›†äº†è©²é—œå¡ä¸­çš„æ‰€æœ‰æ˜Ÿæ˜Ÿ
      const totalStars = lvl.gems.length;
      const collectedStars = lvl.gems.filter(g => g.got).length;
      
      if (collectedStars < totalStars) {
        // æœªæ”¶é›†è¶³å¤ æ˜Ÿæ˜Ÿï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
        playWrong(); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
        openInsufficientStarsMsg();
      } else {
        // æ”¶é›†è¶³å¤ æ˜Ÿæ˜Ÿï¼Œæ­£å¸¸é–‹å•Ÿå‚³é€é–€
        playPortal();
        openQuiz(lvl.gate.quizIndex, "gate");
      }
    }
  }

  // çµ‚é»èˆ‡ä¿¡ä»¶
  if (lvl.goal) {
    const box = {x:lvl.goal.x-8,y:lvl.goal.y-8,w:lvl.goal.w+16,h:lvl.goal.h+16};
    if (rectsIntersect(player, box) && !letterShown) { metPartner = true; playSoftChime(); openLetter(); }
    else if (rectsIntersect(player, box) && letterShown && player.hasBackpack) { playing = false; finalOverlay.style.display = 'grid'; playLevelClear(); }
  }
}
function render() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawStars();
  drawLevel(LEVELS[levelIndex]);
  drawPlayer();
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.font = '16px "Noto Sans TC", sans-serif';
  if (metPartner && levelIndex === 2) {
    ctx.fillText('é‡è¦‹äº†å¦ä¸€å€‹å¹¾ä½•å°ç”Ÿç‰©ï¼ˆç‹—ç‹—ï¼‰ã€‚', 24, 30);
    ctx.fillText('ã€Œç¶“éäº†é‡é‡å›°é›£ï¼Œçµ‚æ–¼èµ°åˆ°é€™è£¡äº†ã€‚ã€', 24, 52);
    ctx.fillText('èµ°è¿‘ä¸€é»ï¼Œæ‰“é–‹é‚£å°å¾é æ–¹å¯„ä¾†çš„ä¿¡â€¦â€¦', 24, 74);
  }
}
// èƒŒæ™¯æ˜Ÿç©ºï¼ˆå®Œæ•´æ˜Ÿå½¢ï¼‰
function drawStars() {
  const t = Date.now()*0.00015;
  for (let i=0;i<90;i++) {
    const x = (i*123.456 + t*800) % canvas.width;
    const y = (i*67.89 + Math.sin(i+t)*30 + 100) % canvas.height;
    ctx.save();
    ctx.globalAlpha = ((i%7)/12)+0.25;
    ctx.fillStyle = '#c4c9ff';
    pathStar(x, y, 3.3, 1.5, 5);
    ctx.fill();
    ctx.restore();
  }
}
function loop(){ update(); render(); requestAnimationFrame(loop); }

/* ===== å•ç­”æµç¨‹ ===== */
function openQuiz(index, mode="gate") {
  quizMode = mode;
  gateLocked = true; playing = false;
  
  // ä¿®æ”¹ï¼šå¦‚æœæ˜¯å¾©æ´»æ¨¡å¼ï¼Œé¸æ“‡ä¸€å€‹æœªä½¿ç”¨éçš„å•é¡Œ
  if (mode === "revive") {
    // å¦‚æœæ‰€æœ‰å•é¡Œéƒ½å·²ç”¨å®Œï¼Œé‡ç½®å·²ä½¿ç”¨çš„å•é¡Œè¨˜éŒ„
    if (usedQuestionIndices.length >= QUESTIONS.length) {
      usedQuestionIndices = [];
    }
    
    // å°‹æ‰¾ä¸€å€‹æœªä½¿ç”¨éçš„å•é¡Œç´¢å¼•
    let newIndex;
    do {
      newIndex = Math.floor(Math.random() * QUESTIONS.length);
    } while (usedQuestionIndices.includes(newIndex) && usedQuestionIndices.length < QUESTIONS.length);
    
    // è¨˜éŒ„é€™å€‹å•é¡Œå·²è¢«ä½¿ç”¨
    usedQuestionIndices.push(newIndex);
    index = newIndex;
  }
  
  const Q = QUESTIONS[(index ?? 0) % QUESTIONS.length];
  
  if (mode === "gate") {
    // æ”¹ç‚ºé¡¯ç¤ºè¨Šæ¯è€Œéå•é¡Œ
    quizTitle.textContent = "å‚³é€é–€";
    quizQ.textContent = "";
    gateMsg.textContent = (index in GATE_MESSAGES) ? GATE_MESSAGES[index] : "åŠ æ²¹ï¼Œç¹¼çºŒå‰é€²ï¼";
    quizChoices.innerHTML = '';
    
    // åªæä¾›ä¸€å€‹ç¹¼çºŒæŒ‰éˆ•
    const b = document.createElement('button');
    b.textContent = "ç¹¼çºŒå‰é€²";
    b.className = "primary";
    b.addEventListener('click', () => {
      playCorrect();
      closeQuiz(true, index);
    });
    quizChoices.appendChild(b);
  } else {
    // å¾©æ´»æ¨¡å¼ä¿æŒå•ç­”å½¢å¼
    quizTitle.textContent = "ğŸ˜ˆå¾©æ´»å•ç­”";
    gateMsg.textContent = "";
    quizQ.textContent = Q.q;
    quizChoices.innerHTML = '';
    Q.choices.forEach((c) => {
      const b = document.createElement('button'); 
      b.textContent = c.t;
      b.addEventListener('click', () => {
        if (c.correct) {
          playCorrect(); 
          closeQuiz(true, index);
        } else {
          playWrong();
          // æ›ä¸‹ä¸€é¡Œï¼Œç¢ºä¿ä¸é‡è¤‡
          openQuiz(null, "revive");
        }
      });
      quizChoices.appendChild(b);
    });
  }
  
  quizOverlay.style.display = 'grid';
}
function closeQuiz(success, index) {
  quizOverlay.style.display = 'none';
  if (success) {
    if (quizMode === "gate") {
      levelIndex++; if (levelIndex >= LEVELS.length) levelIndex = LEVELS.length-1;
      hudLevelNo.textContent = levelIndex + 1; 
      hudLevelName.textContent = LEVEL_NAMES[levelIndex]; // æ›´æ–°é—œå¡åç¨±
      resetPlayer();
    } else if (quizMode === "revive") {
      // å¾©æ´»æˆåŠŸï¼šè£œæ»¿æŒ‡å®šè¡€é‡ä¸¦é‡ç”Ÿ
      player.lives = Math.max(player.lives, REVIVE_HP);
      hudLives.textContent = player.lives;
      resetPlayer();
    }
  }
  playing = true; gateLocked = false;
}

/* ===== ä¿¡ä»¶æµç¨‹ ===== */
function openLetter() {
  playing = false; letterShown = true;
  letterBody.textContent = LETTER_TEXT; letterOverlay.style.display = 'grid';
}
acceptLetterBtn.addEventListener('click', () => {
  letterOverlay.style.display = 'none'; playing = true; player.hasBackpack = true; playPowerUp();
});

/* ===== ç”Ÿå‘½/é‡ç”Ÿï¼ˆå«å¾©æ´»å•ç­”ï¼‰ ===== */
function dieAndMaybeRevive() {
  player.lives--; hudLives.textContent = player.lives;
  if (player.lives <= 0) {
    // å•Ÿå‹•å¾©æ´»å•ç­”ï¼ˆä¸é‡ç½®æ˜Ÿæ˜Ÿæ”¶é›†èˆ‡é—œå¡ï¼‰
    // ä¸å†æŒ‡å®šåˆå§‹å•é¡Œç´¢å¼•ï¼Œè€Œæ˜¯è®“ openQuiz å‡½æ•¸é¸æ“‡æœªä½¿ç”¨çš„å•é¡Œ
    openQuiz(null, "revive");
    return;
  }
  resetPlayer();
}

/* ===== è¼¸å…¥è™•ç†ï¼ˆåŒ…å«é€£è·³ï¼‰ ===== */
document.addEventListener('keydown', (e) => {
  if (!audioCtx) ensureAudio(); // è¡Œå‹•è£ç½®éœ€äº’å‹•å•Ÿç”¨éŸ³è¨Š
  if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys.add(e.code);
  if (e.code === 'Space') {
    if (player.jumpsLeft > 0) {
      player.vy = JUMP_V; player.onGround = false; player.jumpsLeft--;
      playJump();
    }
  }
  if (['ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();
});
document.addEventListener('keyup', (e) => { keys.delete(e.code); });

/* ===== è¨­å®šé¢æ¿è¡Œç‚º ===== */
settingsBtn.addEventListener('click', () => { settingsOverlay.style.display = 'grid'; });
openSettingsFromIntro.addEventListener('click', () => { settingsOverlay.style.display = 'grid'; });
closeSettings.addEventListener('click', () => { settingsOverlay.style.display = 'none'; });
bgmToggle.addEventListener('change', e => setBgm(e.target.checked));
sfxToggle.addEventListener('change', e => setSfx(e.target.checked));
addQ.addEventListener('click', () => {
  const text = qText.value.trim();
  const A = c1.value.trim(), B = c2.value.trim(), C = c3.value.trim();
  const aok = c1ok.checked, bok = c2ok.checked, cok = c3ok.checked;
  if (!text || !(A||B||C) || !(aok||bok||cok)) {
    alert('è«‹è¼¸å…¥å®Œæ•´é¡Œç›®ï¼Œä¸¦è‡³å°‘å‹¾é¸ä¸€å€‹æ­£ç¢ºç­”æ¡ˆã€‚'); return;
  }
  const choices = [];
  if (A) choices.push({t:A, correct:aok});
  if (B) choices.push({t:B, correct:bok});
  if (C) choices.push({t:C, correct:cok});
  QUESTIONS.push({q:text, choices});
  qText.value = c1.value = c2.value = c3.value = '';
  c1ok.checked = c2ok.checked = c3ok.checked = false;
  refreshQCount();
  alert('å·²æ–°å¢é¡Œç›®ï¼');
});
resetQs.addEventListener('click', () => {
  if (confirm('ç¢ºå®šè¦é‚„åŸé è¨­é¡Œç›®å—ï¼Ÿ')) {
    QUESTIONS = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
    refreshQCount();
  }
});

/* ===== éŸ³æ•ˆæ¨£å¼ ===== */
function playJump(){ playTone({freq:520, type:'triangle', dur:0.18, pitchSlide:120, gain:0.35}); }
function playGem(){ const base = 880; playTone({freq:base, type:'sine', dur:0.09, gain:0.35}); setTimeout(()=>playTone({freq:base*1.25, type:'sine', dur:0.09, gain:0.32}), 80); setTimeout(()=>playTone({freq:base*1.5, type:'sine', dur:0.12, gain:0.28}), 160); }
function playHurt(){ playNoise({dur:0.2, gain:0.35}); }
function playCorrect(){ playTone({freq:660, type:'sine', dur:0.12, gain:0.28}); setTimeout(()=>playTone({freq:880, type:'sine', dur:0.12, gain:0.28}), 120); }
function playWrong(){ playTone({freq:220, type:'sawtooth', dur:0.18, gain:0.22}); setTimeout(()=>playTone({freq:196, type:'sawtooth', dur:0.2, gain:0.22}), 120); }
function playPortal(){ playTone({freq:520, type:'square', dur:0.25, gain:0.25, pitchSlide:-200}); }
function playSoftChime(){ playTone({freq:523.25, type:'sine', dur:0.25, gain:0.22}); setTimeout(()=>playTone({freq:659.25, type:'sine', dur:0.35, gain:0.22}), 200); }
function playPowerUp(){ playTone({freq:392, type:'square', dur:0.12, gain:0.28}); setTimeout(()=>playTone({freq:523.25, type:'square', dur:0.12, gain:0.28}), 100); setTimeout(()=>playTone({freq:659.25, type:'square', dur:0.16, gain:0.28}), 200); }
function playLevelClear(){ playTone({freq:523.25, type:'triangle', dur:0.18, gain:0.28}); setTimeout(()=>playTone({freq:659.25, type:'triangle', dur:0.18, gain:0.28}), 160); setTimeout(()=>playTone({freq:783.99, type:'triangle', dur:0.22, gain:0.28}), 320); }

/* ===== é‡é–‹æ©Ÿåˆ¶ï¼šå†ç©ä¸€æ¬¡ => å›é¦–é  ===== */
restartBtn.addEventListener('click', () => {
  finalOverlay.style.display = 'none';
  // é‡ç½®ç‹€æ…‹
  levelIndex = 0;
  hudLevelNo.textContent = 1;
  hudLevelName.textContent = LEVEL_NAMES[0]; // é‡ç½®ç‚ºç¬¬ä¸€é—œåç¨±
  player.lives = 2; hudLives.textContent = 2;  // å¾3æ”¹ç‚º2
  player.gems = 0; hudGems.textContent = 0;
  player.hasBackpack = false;
  letterShown = false; metPartner = false;
  // é‡ç½®é—œå¡æ˜Ÿæ˜Ÿ
  LEVELS.forEach(lvl => lvl.gems.forEach(g => g.got = false));
  // é‡ç½®å·²ä½¿ç”¨çš„å•é¡Œè¨˜éŒ„
  usedQuestionIndices = [];
  resetPlayer();
  playing = false;
  introOverlay.style.display = 'grid'; // å›åˆ°é¦–é ï¼ˆé–‹é ­æ•…äº‹ï¼‰
});

/* ===== å•Ÿå‹• ===== */
function fullResetForIntro() {
  resetPlayer();
  player.lives = 2;  // ç¢ºä¿åˆå§‹åŒ–æ™‚ä¹Ÿæ˜¯2æ¢å‘½
  hudLives.textContent = 2;  // æ›´æ–°UIé¡¯ç¤º
  hudLevelName.textContent = LEVEL_NAMES[0]; // åˆå§‹åŒ–æ™‚é¡¯ç¤ºç¬¬ä¸€é—œåç¨±
  playing = false;
  introOverlay.style.display = 'grid';
}
fullResetForIntro();
loop();

// é–‹å ´é¡¯ç¤ºæ•…äº‹ & é å…ˆè¨­å®šåˆ‡æ›ç‹€æ…‹
bgmToggle.checked = true; sfxToggle.checked = true;

startBtn.addEventListener('click', () => {
  introOverlay.style.display = 'none';
  playing = true;
  setBgm(true); // ä½¿ç”¨è€…äº’å‹•å¾Œå•Ÿå‹• BGM
});

// ä¿®æ”¹é¡¯ç¤ºæ˜Ÿæ˜Ÿä¸è¶³è¨Šæ¯çš„å‡½æ•¸
function openInsufficientStarsMsg() {
  gateLocked = true; playing = false;
  
  quizTitle.textContent = "æ˜Ÿæ˜Ÿä¸è¶³";
  quizQ.textContent = "å”‰å‘¦ï¼ä½ çš„è¡Œå›Šè£¡å¥½åƒç¼ºå°‘è¶³å¤ çš„æ˜Ÿæ˜Ÿå‰å¾€ä¸‹ä¸€é—œå‘¢";
  gateMsg.textContent = "è©¦è‘—æ”¶é›†æœ¬é—œæ‰€æœ‰çš„æ˜Ÿæ˜Ÿå§ï¼";
  quizChoices.innerHTML = '';
  
  // æä¾›ä¸€å€‹ç¹¼çºŒæŒ‰éˆ•
  const b = document.createElement('button');
  b.textContent = "æˆ‘å†å»æ‰¾æ‰¾";
  b.className = "primary";
  b.addEventListener('click', () => {
    quizOverlay.style.display = 'none';
    // å°‡ç©å®¶é‡ç½®åˆ°é—œå¡èµ·é»
    resetPlayer();
    playing = true;
    gateLocked = false;
  });
  quizChoices.appendChild(b);
  
  quizOverlay.style.display = 'grid';
}
</script>
</body>
</html>

